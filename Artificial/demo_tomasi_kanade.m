%MANUAL measurement matrix (also in measurementmatrix.m
Wx = [
    858  768  893  1107 769  894  1107 392  1009 1486 390  1016 1486;
    789  684  798  1014 691  805  1021 304  869  1409 304  873  1409;
    793  687  801  1017 687  800  1016 299  862  1404 299  864  1404;
    867  755  861  1088 744  856  1077 346  905  1474 345  905  1473;
    857  772  865  1047 748  848  1026 428  909  1348 425  907  1346;
    944  814  898  1119 808  899  1115 409  849  1516 407  850  1515;
    778  696  797  975  700  800  979  382  877  1299 380  883  1299;
    787  625  731  995  624  730  994  134  659  1483 134  660  1483;
    763  624  699  909  611  686  897  214  591  1293 213  583  1292;
    803  693  799  1033 693  806  1026 295  859  1424 295  861  1424;
    794  721  790  950  721  797  943  455  831  1209 455  833  1209;
    672  642  744  869  640  743  871  422  928  1090 422  935  1092;
    723  667  854  1090 664  852  1091 266  1194 1490 266  1201 1492;
    837  674  777  1038 674  776  1039 185  694  1527 185  696  1527;
    846  776  818  940  771  823  938  554  794  1158 552  794  1158;
];

Wy = [
    166  206  236  226  502  530  520  537  683  519  565  707  519;  
    112  164  208  200  448  488  481  485  696  451  512  719  477;
    113  175  229  226  443  495  493  474  750  466  501  772  492;
    42   113  186  194  351  426  433  375  767  414  400  786  437;
    149  219  295  296  374  454  457  415  790  429  430  768  446;
    84   141  219  249  392  470  499  374  784  521  398  808  545;
    175  215  247  238  458  485  478  490  640  452  513  658  474;
    128  157  198  210  534  572  587  528  725  601  562  759  636;
    214  228  262  282  538  569  591  513  679  625  541  704  652;
    59   130  191  195  387  449  449  420  750  420  446  771  446;
    210  258  298  303  430  471  471  452  673  452  470  686  470;
    281  317  333  304  515  527  503  571  639  453  541  651  471;
    212  277  303  254  640  662  618  742  861  522  713  890  556;
    233  265  313  324  635  683  701  629  860  719  663  893  753;
    267  299  339  355  437  477  492  425  650  505  438  663  518;
];

W = [Wx; Wy];

%centroid subtract W
[r, c] = size(W);
for n = 1:r
    avg = sum(W(n,:), 'all')/r;
    W(n,:) = W(n,:) - avg;
end

%singular value decomposition into 3 parts, then into 2
[U,S,V] = svd(W);
U1 = U(:,1:3);
S1 = S(1:3,1:3);
V = V';
V1 = V(1:3,:);

M_hat = U1*sqrtm(S1);
S_hat = sqrtm(S1)*V1;



A = [];
B = [];

%going through one frame at a time
for i = 1:r/2
    %getting the i and j vectors for each frame
    m11 = M_hat(2*i-1,1);
    m12 = M_hat(2*i-1,2);
    m13 = M_hat(2*i-1,3);
    m21 = M_hat(2*i,1);
    m22 = M_hat(2*i,2);
    m23 = M_hat(2*i,3);
   
    %first row is i^T * i, second row is j^T * j, third row is i^T * j
    A = [A;
         m11*m11 m11*m12+m12*m11 m11*m13+m13*m11 m12*m12 m13*m12+m12*m13 m13*m13;
         m21*m21 m21*m22+m22*m21 m21*m23+m23*m21 m22*m22 m23*m22+m22*m23 m23*m23;
         m11*m21 m11*m22+m12*m21 m11*m23+m13*m21 m12*m22 m12*m23+m22*m13 m13*m23];
    
    %now these have to be equal to 1 1 and 0 respectively
    B = [B; 1; 1; 0];
end

%get each rows solution for all frames
QQT_prime = A \ B;

%put it in proper dimensions
QQT = [QQT_prime(1), QQT_prime(2), QQT_prime(3);
      QQT_prime(2), QQT_prime(4), QQT_prime(5);
      QQT_prime(3), QQT_prime(5), QQT_prime(6)];

%use choelsky decomposition to get Q separate from Q^T
Q = chol(QQT);

%now recover motion and structure
M = M_hat*Q;
S = Q^(-1)*S_hat;


figure()
scatter3(S(1, :), S(2, :), S(3, :), 'filled');
axis equal